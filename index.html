<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint Learning Academy</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#334155">
    <link rel="apple-touch-icon" href="assets/icon-180.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuDfXYIvyUcOhUCOfUtcUiovi1r9wFXYU",
            authDomain: "blueprintlearningacademy.firebaseapp.com",
            projectId: "blueprintlearningacademy",
            storageBucket: "blueprintlearningacademy.firebasestorage.app",
            messagingSenderId: "531353465697",
            appId: "1:531353465697:web:4ab3542f71db960d65cb20"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Expose to Global Window for React Component Access
        window.firebaseServices = {
            auth,
            db,
            provider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            onSnapshot
        };
        
        console.log("Firebase & Firestore Initialized:", app.name);
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registered');
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <style>
        :root {
            --ink-primary: #334155; /* Slate 700 */
            --ink-accent: #475569;  /* Slate 600 */
            --paper-bg: #fdfbf7;     /* Off-white warm paper */
            --grid-line: #e2e8f0;    /* Slate 200 */
            --blueprint-blue: #2563eb;
        }

        body {
            background-color: var(--paper-bg);
            color: var(--ink-primary);
            font-family: 'Rajdhani', sans-serif;
            overscroll-behavior-y: none; /* Prevents pull-to-refresh on Android PWA */
        }

        /* 1. Drafting Paper Grid Background */
        .drafting-paper {
            background-color: var(--paper-bg);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 24px 24px;
            position: relative;
        }
        
        .drafting-paper::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* 2. Sketchy Borders & Effects */
        .hatch-shadow {
            box-shadow: 6px 6px 0px var(--ink-primary);
        }
        
        .hatch-shadow-sm {
            box-shadow: 3px 3px 0px var(--ink-primary);
        }

        .handwritten {
            font-family: 'Architects Daughter', cursive;
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
            border-left: 1px solid var(--grid-line);
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--ink-accent);
            border: 2px solid var(--paper-bg);
        }

        /* Animations */
        @keyframes drawIn {
            from { stroke-dashoffset: 1000; opacity: 0; }
            to { stroke-dashoffset: 0; opacity: 1; }
        }
        
        .animate-draw {
            animation: drawIn 2s ease-out forwards;
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(51, 65, 85, 0.8);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="drafting-paper min-h-screen">
    <div id="root" class="relative z-10 min-h-screen flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Utils ---
        
        const extractVideoID = (url) => {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : false;
        };

        const fetchVideoTitle = async (id) => {
            try {
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`);
                const data = await response.json();
                return data.title || `Module ${id}`;
            } catch (e) {
                return `Module ${id}`;
            }
        };

        const triggerConfetti = () => {
            const duration = 3000;
            const end = Date.now() + duration;
            const colors = ['#334155', '#2563eb', '#e2e8f0', '#ffffff'];
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: colors });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: colors });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        };

        // --- Components ---

        // 1. Setup / Input Screen
        const SetupScreen = ({ onComplete, onCancel, showCancel, onLogin, user }) => {
            const [inputText, setInputText] = useState('');
            const [error, setError] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);

            const handleProcess = async () => {
                setError('');
                setIsProcessing(true);
                let processedVideos = [];
                try {
                    const lines = inputText.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2 || lines.length > 12) throw new Error('Please enter between 2 and 12 YouTube links.');

                    for (let line of lines) {
                        const id = extractVideoID(line);
                        if (id) {
                            const title = await fetchVideoTitle(id);
                            processedVideos.push({ id, title, originalUrl: line });
                        }
                    }

                    if (processedVideos.length === 0) throw new Error('No valid videos found.');
                    onComplete(processedVideos);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="flex-1 flex items-center justify-center p-4">
                    <div className="max-w-2xl w-full bg-white border-2 border-slate-700 p-8 hatch-shadow relative">
                        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-yellow-100/80 border border-slate-300 rotate-1 shadow-sm"></div>

                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-3xl font-bold uppercase tracking-widest text-slate-800">New Blueprint</h2>
                                <p className="handwritten text-slate-500">Create a new learning track manually.</p>
                            </div>
                            {user ? (
                                <div className="flex items-center gap-3 px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-sm">
                                    <div className="text-right hidden sm:block">
                                        <div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Logged In As</div>
                                        <div className="text-xs font-bold text-slate-700">{user.email}</div>
                                    </div>
                                    {user.photoURL ? (
                                        <img src={user.photoURL} className="w-8 h-8 rounded-full border border-slate-300" alt="User" />
                                    ) : (
                                        <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-xs">
                                            {user.email?.[0].toUpperCase()}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <button 
                                    onClick={onLogin}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 font-bold uppercase text-xs border border-blue-200 hover:bg-blue-100 transition-colors"
                                >
                                    <i className="ph-bold ph-sign-in"></i> Already have data? Login
                                </button>
                            )}
                        </div>

                        <div className="mb-6">
                            <label className="block text-xs font-bold uppercase tracking-wider text-slate-600 mb-2">Input Source (Dropbox)</label>
                            <div className="relative">
                                <textarea
                                    className="w-full h-48 p-4 border-2 border-slate-300 bg-slate-50 font-mono text-sm focus:border-blue-600 focus:outline-none resize-none"
                                    placeholder="Paste YouTube links here...&#10;https://www.youtube.com/watch?v=...&#10;https://youtu.be/..."
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                ></textarea>
                                <div className="absolute bottom-4 right-4 text-xs text-slate-400 font-mono">
                                    {inputText.split('\n').filter(l => l.trim()).length} / 12 Links
                                </div>
                            </div>
                        </div>

                        {error && (
                            <div className="mb-6 p-3 bg-red-50 border border-red-200 text-red-600 text-sm flex items-center gap-2">
                                <i className="ph-bold ph-warning"></i> {error}
                            </div>
                        )}

                        <div className="flex gap-3">
                            {showCancel && (
                                <button onClick={onCancel} className="px-6 py-4 bg-white text-slate-500 font-bold uppercase tracking-widest hover:bg-slate-50 border-2 border-slate-300">
                                    Cancel
                                </button>
                            )}
                            <button onClick={handleProcess} disabled={isProcessing} className="flex-1 py-4 bg-slate-800 text-white font-bold uppercase tracking-widest hover:bg-blue-700 transition-colors border-2 border-transparent hover:border-slate-800 disabled:opacity-50">
                                {isProcessing ? 'Analyzing Content...' : 'Generate Modules'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Verification Screen
        const VerifyScreen = ({ videos, onConfirm, onBack }) => {
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-4">
                    <div className="max-w-4xl w-full">
                        <div className="mb-8 text-center">
                            <h2 className="text-3xl font-bold uppercase tracking-widest text-slate-800">Verify Content</h2>
                            <p className="handwritten text-slate-500">Step 2: Confirm your module list.</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 max-h-[60vh] overflow-y-auto custom-scroll p-2">
                            {videos.map((video, idx) => (
                                <div key={idx} className="bg-white border-2 border-slate-700 p-3 hatch-shadow-sm flex flex-col">
                                    <div className="aspect-video bg-slate-100 border border-slate-200 mb-3 relative overflow-hidden group">
                                        <img src={`https://img.youtube.com/vi/${video.id}/mqdefault.jpg`} className="w-full h-full object-cover" />
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-xs font-mono text-slate-400 mb-1">MODULE {String(idx + 1).padStart(2, '0')}</div>
                                        <h4 className="font-bold text-sm leading-tight text-slate-800 line-clamp-2">{video.title}</h4>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-center gap-4">
                            <button onClick={onBack} className="px-8 py-3 border-2 border-slate-300 text-slate-500 font-bold uppercase hover:border-slate-500 hover:text-slate-700 bg-white">Back</button>
                            <button onClick={onConfirm} className="px-8 py-3 bg-blue-600 text-white font-bold uppercase border-2 border-blue-800 hover:bg-blue-500 hover:-translate-y-1 transition-transform shadow-lg">Confirm & Launch</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Learning App
        const LearningApp = ({ 
            courses, activeCourseId, onSwitchCourse, onAddCourse, onUpdateCourse, onDeleteCourse, 
            completedMap, onToggleComplete, notes, onNoteChange, videoProgress, onProgressUpdate,
            user, onLogin, onLogout
        }) => {
            const activeCourse = courses.find(c => c.id === activeCourseId);
            const [viewMode, setViewMode] = useState('learn');
            const [currentModuleId, setCurrentModuleId] = useState(activeCourse ? activeCourse.modules[0].id : null);
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [nextModuleId, setNextModuleId] = useState(null);
            const [showCourseComplete, setShowCourseComplete] = useState(false);

            useEffect(() => {
                if (activeCourse && (!currentModuleId || !activeCourse.modules.find(m => m.id === currentModuleId))) {
                    setCurrentModuleId(activeCourse.modules[0].id);
                }
            }, [activeCourseId, activeCourse]);

            if (!activeCourse) return null;

            const currentModule = activeCourse.modules.find(m => m.id === currentModuleId) || activeCourse.modules[0];
            const courseCompletedIds = completedMap[activeCourseId] || [];
            const progressPercent = Math.round((courseCompletedIds.length / activeCourse.modules.length) * 100);
            const currentNoteKey = `${activeCourseId}-${currentModuleId}`;
            const currentNoteValue = notes[currentNoteKey] || '';
            const initialResumeTime = videoProgress[currentModuleId] || 0;

            const handleVideoEnd = () => {
                if (!courseCompletedIds.includes(currentModuleId)) {
                    onToggleComplete(activeCourseId, currentModuleId);
                }
                const currentIndex = activeCourse.modules.findIndex(m => m.id === currentModuleId);
                if (currentIndex < activeCourse.modules.length - 1) {
                    setNextModuleId(activeCourse.modules[currentIndex + 1].id);
                } else {
                    setShowCourseComplete(true);
                    triggerConfetti();
                }
            };

            const advanceToNext = () => {
                if (nextModuleId) {
                    setCurrentModuleId(nextModuleId);
                    setNextModuleId(null);
                }
            };

            // -- App Header --
            const AppHeader = () => (
                <header className="sticky top-0 z-50 bg-[#fdfbf7] border-b-2 border-slate-700 px-4 py-3 shadow-sm">
                    <div className="max-w-7xl mx-auto flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 border-2 border-slate-700 flex items-center justify-center bg-white hatch-shadow-sm transform -rotate-2 overflow-hidden text-slate-700">
                                    <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M16 23C21.5228 23 26 19.4183 26 15C26 10.5817 21.5228 7 16 7C10.4772 7 6 10.5817 6 15C6 19.4183 10.4772 23 16 23Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <circle cx="16" cy="15" r="4" fill="currentColor"/>
                                        <path d="M10 7L8 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                                        <path d="M16 7L16 3" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                                        <path d="M22 7L24 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold uppercase tracking-wider text-slate-800 leading-none">
                                        Blueprint <span className="text-blue-700">Academy</span>
                                    </h1>
                                    <span className="text-xs font-medium text-slate-500 uppercase tracking-[0.2em] handwritten">
                                        {user ? `Pilot: ${user.email}` : 'Learning Platform v4.0'}
                                    </span>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="hidden md:block w-48">
                                    <div className="h-2 border border-slate-700 bg-white p-[1px]">
                                        <div className="h-full bg-slate-700 transition-all duration-500" style={{width: `${progressPercent}%`}}></div>
                                    </div>
                                </div>
                                {user ? (
                                    <div className="flex items-center gap-2">
                                        {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-slate-300" alt="User" />}
                                        <button onClick={onLogout} className="text-xs font-bold uppercase text-slate-500 hover:text-red-500">Sign Out</button>
                                    </div>
                                ) : (
                                    <button onClick={onLogin} className="px-4 py-1 border-2 border-slate-700 text-xs font-bold uppercase hover:bg-slate-800 hover:text-white transition-colors">Sign In</button>
                                )}
                            </div>
                        </div>

                        <div className="flex gap-2 overflow-x-auto pb-1 custom-scroll">
                            {courses.map(course => (
                                <button
                                    key={course.id}
                                    onClick={() => onSwitchCourse(course.id)}
                                    className={`whitespace-nowrap px-4 py-2 text-xs font-bold uppercase tracking-wider border-2 transition-all ${course.id === activeCourseId ? 'bg-blue-600 border-blue-800 text-white shadow-md transform -translate-y-1' : 'bg-white border-slate-300 text-slate-500 hover:border-slate-500 hover:text-slate-700'}`}
                                >
                                    {course.title}
                                </button>
                            ))}
                            <button onClick={onAddCourse} className="whitespace-nowrap px-4 py-2 text-xs font-bold uppercase tracking-wider border-2 border-slate-300 border-dashed text-slate-400 hover:border-blue-500 hover:text-blue-600 bg-slate-50 hover:bg-white">+ New Course</button>
                        </div>
                    </div>
                </header>
            );

            // -- Video Player --
            const VideoPlayer = ({ videoId, initialTime, onVideoEnd, onTimeUpdate }) => {
                const playerRef = useRef(null);
                const timerRef = useRef(null);
                
                useEffect(() => {
                    if(timerRef.current) clearInterval(timerRef.current);
                    if (!window.YT) {
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        const firstScriptTag = document.getElementsByTagName('script')[0];
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                    }
                    window.onYouTubeIframeAPIReady = loadPlayer;
                    if (window.YT && window.YT.Player) loadPlayer();
                    return () => { 
                        if(playerRef.current) playerRef.current.destroy(); 
                        if(timerRef.current) clearInterval(timerRef.current);
                    }
                }, [videoId]);

                const loadPlayer = () => {
                    if(playerRef.current) playerRef.current.destroy();
                    const startSeconds = Math.floor(initialTime) || 0;
                    playerRef.current = new window.YT.Player('yt-player', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: { 'rel': 0, 'modestbranding': 1, 'start': startSeconds },
                        events: { 'onStateChange': onPlayerStateChange }
                    });
                };

                const onPlayerStateChange = (event) => {
                    if (event.data === 1) { // PLAYING
                        if(timerRef.current) clearInterval(timerRef.current);
                        timerRef.current = setInterval(() => {
                            if(playerRef.current && playerRef.current.getCurrentTime) {
                                onTimeUpdate(playerRef.current.getCurrentTime());
                            }
                        }, 5000);
                    } else if (event.data === 2 || event.data === 0) { // PAUSED/ENDED
                        if(timerRef.current) clearInterval(timerRef.current);
                        if(playerRef.current && playerRef.current.getCurrentTime) {
                            onTimeUpdate(playerRef.current.getCurrentTime());
                        }
                    }
                    if (event.data === 0) onVideoEnd();
                };

                const isDone = courseCompletedIds.includes(videoId);

                return (
                    <div className="bg-white border-2 border-slate-700 p-2 hatch-shadow">
                        <div className="aspect-video w-full bg-black relative">
                             <div id="yt-player" className="w-full h-full"></div>
                        </div>
                        <div className="mt-4 p-2 flex justify-between items-center">
                            <div>
                                <h2 className="text-lg font-bold uppercase text-slate-800">{currentModule.title}</h2>
                                <span className="text-xs font-mono text-slate-500">ID: {videoId}</span>
                                {initialTime > 0 && <span className="ml-3 text-xs font-mono text-blue-600 bg-blue-50 px-2 py-1 rounded">Resumed at {Math.floor(initialTime / 60)}:{(Math.floor(initialTime) % 60).toString().padStart(2, '0')}</span>}
                            </div>
                            <button disabled={!isDone} className={`px-4 py-2 border-2 text-sm font-bold uppercase transition-all flex items-center gap-2 ${isDone ? 'bg-green-100 border-green-600 text-green-800 cursor-default' : 'bg-slate-100 border-slate-300 text-slate-400 cursor-not-allowed opacity-70'}`}>
                                {isDone ? <><i className="ph-bold ph-check-square"></i> Verified</> : <><i className="ph-bold ph-lock-key"></i> Watch to Verify</>}
                            </button>
                        </div>
                    </div>
                );
            };

            // -- Sidebar --
            const Sidebar = () => (
                <div className="border-2 border-slate-700 bg-[#fdfbf7] h-full flex flex-col">
                    <div className="bg-slate-800 p-3">
                         {isEditingTitle ? (
                            <input autoFocus className="w-full text-sm font-bold uppercase tracking-widest text-white bg-slate-900 border-b border-blue-500 focus:outline-none p-1" value={activeCourse.title} onChange={(e) => onUpdateCourse(activeCourse.id, { ...activeCourse, title: e.target.value })} onBlur={() => setIsEditingTitle(false)} onKeyDown={(e) => e.key === 'Enter' && setIsEditingTitle(false)} />
                        ) : (
                            <div className="flex justify-between items-center group cursor-pointer" onClick={() => setIsEditingTitle(true)}>
                                <h3 className="text-white font-bold uppercase text-sm tracking-widest truncate mr-2">{activeCourse.title}</h3>
                                <i className="ph-bold ph-pencil-simple text-slate-500 group-hover:text-white transition-colors"></i>
                            </div>
                        )}
                        <div className="flex gap-2 mt-2 text-[10px] font-mono uppercase text-slate-400">
                             <span onClick={() => setViewMode('learn')} className={`cursor-pointer ${viewMode === 'learn' ? 'text-blue-400' : 'hover:text-white'}`}>[Modules]</span>
                             <span onClick={() => setViewMode('dashboard')} className={`cursor-pointer ${viewMode === 'dashboard' ? 'text-blue-400' : 'hover:text-white'}`}>[Dashboard]</span>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll bg-white">
                        {activeCourse.modules.map((m, idx) => {
                            const isActive = currentModuleId === m.id;
                            const isDone = courseCompletedIds.includes(m.id);
                            return (
                                <div key={m.id} className={`border-b border-slate-100 p-3 group relative transition-colors ${isActive ? 'bg-blue-50' : 'hover:bg-slate-50'}`}>
                                    {isActive && <div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-600"></div>}
                                    <div className="flex items-start gap-3">
                                        <button onClick={() => setCurrentModuleId(m.id)} className={`mt-1 w-6 h-6 flex-shrink-0 border rounded-sm flex items-center justify-center text-xs font-mono ${isActive ? 'border-blue-600 text-blue-600 bg-white' : 'border-slate-300 text-slate-400'}`}>{idx + 1}</button>
                                        <div className="flex-1 min-w-0">
                                            <button onClick={() => setCurrentModuleId(m.id)} className="text-left"><h4 className={`text-sm font-bold uppercase leading-tight ${isDone ? 'text-slate-400 line-through' : 'text-slate-700'}`}>{m.title}</h4></button>
                                        </div>
                                        <div className="mt-1">{isDone && <i className="ph-fill ph-check-circle text-green-500"></i>}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="p-3 border-t-2 border-slate-700 bg-slate-100">
                        <button onClick={() => { if(confirm(`Delete "${activeCourse.title}"?`)) onDeleteCourse(activeCourse.id); }} className="w-full text-xs font-bold text-red-500 hover:text-red-700 uppercase tracking-widest border border-red-200 hover:bg-red-50 py-2">Delete Course</button>
                    </div>
                </div>
            );

            const Dashboard = () => (
                <div className="p-8 max-w-5xl mx-auto w-full animate-draw">
                    <h2 className="text-4xl font-bold uppercase tracking-widest text-slate-800 mb-2">Progress Report</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div className="col-span-1 md:col-span-3 bg-white border-2 border-slate-700 p-6 hatch-shadow flex items-center justify-between">
                            <div><div className="text-xs font-bold uppercase text-slate-500 tracking-widest">Total Completion</div><div className="text-5xl font-mono font-bold text-slate-800 mt-2">{progressPercent}%</div></div>
                            <div className="w-32 h-32 relative flex items-center justify-center">
                                <svg viewBox="0 0 36 36" className="w-full h-full transform -rotate-90">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e2e8f0" strokeWidth="4" />
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#2563eb" strokeWidth="4" strokeDasharray={`${progressPercent}, 100`} />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {activeCourse.modules.map((m, i) => {
                            const isDone = courseCompletedIds.includes(m.id);
                            return (
                                <div key={m.id} className={`p-4 border-l-4 ${isDone ? 'border-green-500 bg-green-50/30' : 'border-slate-300 bg-white'}`}>
                                    <div className="flex justify-between items-center">
                                        <div><div className="text-xs font-mono text-slate-400 mb-1">MODULE {i+1}</div><div className="font-bold text-slate-700">{m.title}</div></div>
                                        <div className={`px-3 py-1 text-xs font-bold uppercase rounded-full ${isDone ? 'bg-green-200 text-green-800' : 'bg-slate-200 text-slate-500'}`}>{isDone ? 'Complete' : 'Pending'}</div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen relative">
                    <AppHeader />
                    <main className="flex-1 flex overflow-hidden">
                        {viewMode === 'learn' ? (
                            <div className="flex-1 flex flex-col lg:flex-row h-full max-w-7xl mx-auto w-full p-4 lg:p-6 gap-6 relative">
                                <div className="flex-1">
                                    <VideoPlayer videoId={currentModuleId} initialTime={initialResumeTime} onVideoEnd={handleVideoEnd} onTimeUpdate={(t) => onProgressUpdate(currentModuleId, t)} />
                                    <div className="mt-6 p-6 border-2 border-slate-200 border-dashed rounded-lg bg-slate-50/50">
                                        <div className="flex justify-between items-center mb-2"><h3 className="font-bold uppercase text-slate-400 text-sm tracking-widest">Notes: {currentModule.title}</h3><span className="text-[10px] uppercase text-slate-300 font-mono">{user ? 'Cloud Sync Active' : 'Local Storage'}</span></div>
                                        <textarea className="w-full h-32 bg-transparent resize-none focus:outline-none handwritten text-slate-600" placeholder="Type your observations here..." value={currentNoteValue} onChange={(e) => onNoteChange(activeCourseId, currentModuleId, e.target.value)}></textarea>
                                    </div>
                                </div>
                                <div className="w-full lg:w-96 lg:h-[calc(100vh-8rem)] sticky top-4">
                                    <Sidebar />
                                </div>
                                {nextModuleId && (
                                    <div className="absolute inset-0 z-40 flex items-center justify-center p-4 modal-overlay">
                                        <div className="bg-white border-2 border-slate-700 p-8 hatch-shadow max-w-md w-full text-center animate-draw">
                                            <i className="ph-bold ph-check-circle text-5xl text-green-500 mb-4"></i>
                                            <h3 className="text-2xl font-bold uppercase tracking-widest text-slate-800 mb-2">Module Verified</h3>
                                            <p className="text-slate-500 handwritten mb-6">Ready for the next transmission?</p>
                                            <div className="flex gap-4 justify-center">
                                                <button onClick={() => setNextModuleId(null)} className="px-6 py-3 border-2 border-slate-300 text-slate-500 font-bold uppercase hover:bg-slate-50">Stay Here</button>
                                                <button onClick={advanceToNext} className="px-6 py-3 bg-blue-600 text-white font-bold uppercase border-2 border-blue-800 hover:bg-blue-700 hover:-translate-y-1 transition-transform shadow-lg">Next Module <i className="ph-bold ph-arrow-right ml-1"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <Dashboard />
                        )}
                    </main>
                    {showCourseComplete && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white border-2 border-slate-700 p-12 hatch-shadow max-w-lg w-full text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
                                <i className="ph-fill ph-trophy text-6xl text-yellow-500 mb-4 animate-bounce"></i>
                                <h2 className="text-4xl font-bold uppercase tracking-widest text-slate-800 mb-2">Course Certified</h2>
                                <p className="text-lg text-slate-600 handwritten mb-8">You have successfully completed all modules.</p>
                                <button onClick={() => setShowCourseComplete(false)} className="px-8 py-3 bg-slate-800 text-white font-bold uppercase tracking-widest hover:bg-slate-700">Return to Dashboard</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Root Coordinator ---
        const App = () => {
            const [user, setUser] = useState(null);
            
            // Core State
            const [courses, setCourses] = useState([]);
            const [completedMap, setCompletedMap] = useState({});
            const [notes, setNotes] = useState({});
            const videoProgress = useRef({});

            // UI State
            const [activeCourseId, setActiveCourseId] = useState(null);
            const [view, setView] = useState('loading'); 
            const [tempData, setTempData] = useState([]);

            // 1. Auth Listener
            useEffect(() => {
                if(window.firebaseServices) {
                    const unsubscribe = window.firebaseServices.onAuthStateChanged(window.firebaseServices.auth, (u) => {
                        setUser(u);
                        if (!u) {
                            // Load from LocalStorage if guest
                            loadFromLocal();
                        }
                    });
                    return () => unsubscribe();
                } else {
                    loadFromLocal();
                }
            }, []);

            // 2. Data Sync (Firestore vs Local)
            useEffect(() => {
                if (user && window.firebaseServices) {
                    // CLOUD SYNC
                    const { db, doc, onSnapshot } = window.firebaseServices;
                    const userDoc = doc(db, 'users', user.uid);
                    
                    const unsub = onSnapshot(userDoc, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setCourses(data.courses || []);
                            setCompletedMap(data.completedMap || {});
                            setNotes(data.notes || {});
                            videoProgress.current = data.videoProgress || {};
                            
                            // If we were on setup but found data, go to learning
                            if (view === 'setup' && data.courses && data.courses.length > 0) {
                                setView('learning');
                                setActiveCourseId(data.courses[0].id);
                            } else if (view === 'loading') {
                                if (data.courses && data.courses.length > 0) {
                                    setView('learning');
                                    setActiveCourseId(data.courses[0].id);
                                } else {
                                    setView('setup');
                                }
                            }
                        } else {
                            // New cloud user
                            if (view === 'loading') setView('setup');
                        }
                    });
                    return () => unsub();
                }
            }, [user]);

            const loadFromLocal = () => {
                const localCourses = JSON.parse(localStorage.getItem('opus_courses') || '[]');
                const localMap = JSON.parse(localStorage.getItem('opus_progress_map') || '{}');
                const localNotes = JSON.parse(localStorage.getItem('opus_notes') || '{}');
                videoProgress.current = JSON.parse(localStorage.getItem('opus_video_progress') || '{}');
                
                setCourses(localCourses);
                setCompletedMap(localMap);
                setNotes(localNotes);

                if (localCourses.length > 0) {
                    setActiveCourseId(localCourses[0].id);
                    setView('learning');
                } else {
                    setView('setup');
                }
            };

            // 3. Save Logic
            const saveData = (newCourses, newMap, newNotes, newVideoProgress) => {
                // Update State
                if(newCourses) setCourses(newCourses);
                if(newMap) setCompletedMap(newMap);
                if(newNotes) setNotes(newNotes);
                
                const dataToSave = {
                    courses: newCourses || courses,
                    completedMap: newMap || completedMap,
                    notes: newNotes || notes,
                    videoProgress: newVideoProgress || videoProgress.current
                };

                if (user && window.firebaseServices) {
                    // Cloud Save
                    const { db, doc, setDoc } = window.firebaseServices;
                    setDoc(doc(db, 'users', user.uid), dataToSave, { merge: true });
                } else {
                    // Local Save
                    if(newCourses) localStorage.setItem('opus_courses', JSON.stringify(newCourses));
                    if(newMap) localStorage.setItem('opus_progress_map', JSON.stringify(newMap));
                    if(newNotes) localStorage.setItem('opus_notes', JSON.stringify(newNotes));
                    if(newVideoProgress) localStorage.setItem('opus_video_progress', JSON.stringify(newVideoProgress));
                }
            };

            // Actions
            const handleLogin = async () => {
                if (window.firebaseServices) {
                    try {
                        await window.firebaseServices.signInWithPopup(window.firebaseServices.auth, window.firebaseServices.provider);
                    } catch (e) { console.error(e); alert("Login Failed"); }
                }
            };

            const handleLogout = async () => {
                if (window.firebaseServices) {
                    await window.firebaseServices.signOut(window.firebaseServices.auth);
                    setView('setup'); // Reset to setup on logout
                    setCourses([]);
                }
            };

            const handleSetupComplete = (data) => {
                setTempData(data);
                setView('verify');
            };

            const handleVerifyConfirm = () => {
                const newCourse = {
                    id: crypto.randomUUID(),
                    title: `Course ${courses.length + 1}`,
                    modules: tempData
                };
                const updatedCourses = [...courses, newCourse];
                saveData(updatedCourses, null, null, null);
                
                setActiveCourseId(newCourse.id);
                setView('learning');
                setTempData([]);
            };

            const handleToggleComplete = (courseId, videoId) => {
                const current = completedMap[courseId] || [];
                const updated = current.includes(videoId) ? current.filter(id => id !== videoId) : [...current, videoId];
                const newMap = { ...completedMap, [courseId]: updated };
                saveData(null, newMap, null, null);
            };

            const handleUpdateCourse = (id, updatedCourse) => {
                const updatedCourses = courses.map(c => c.id === id ? updatedCourse : c);
                saveData(updatedCourses, null, null, null);
            };

            const handleDeleteCourse = (id) => {
                const updatedCourses = courses.filter(c => c.id !== id);
                const newMap = { ...completedMap };
                delete newMap[id];
                saveData(updatedCourses, newMap, null, null);
                
                if (updatedCourses.length > 0) setActiveCourseId(updatedCourses[0].id);
                else setView('setup');
            };

            // Debounced Note Save
            const handleNoteChange = (courseId, videoId, text) => {
                const key = `${courseId}-${videoId}`;
                const newNotes = { ...notes, [key]: text };
                setNotes(newNotes); // Update UI immediately
                
                // Debounce save to cloud
                clearTimeout(window.noteSaveTimeout);
                window.noteSaveTimeout = setTimeout(() => {
                    saveData(null, null, newNotes, null);
                }, 1000);
            };

            const handleProgressUpdate = (videoId, time) => {
                videoProgress.current[videoId] = time;
                // Only save to cloud periodically or on pause to save writes, but here we do it lightly
                // Ideally, we'd debounce this too, but let's save every 5s via the player component interval
                // We actually trigger this function every 5s from the player.
                // So let's save it.
                saveData(null, null, null, videoProgress.current);
            };

            if (view === 'loading') return <div className="h-screen flex items-center justify-center font-bold text-slate-400">LOADING SYSTEM...</div>;

            if (view === 'setup') {
                return (
                    <SetupScreen 
                        onComplete={handleSetupComplete} 
                        showCancel={courses.length > 0} 
                        onCancel={() => setView('learning')}
                        onLogin={handleLogin}
                        user={user} // Added this
                    />
                );
            }

            if (view === 'verify') {
                return <VerifyScreen videos={tempData} onConfirm={handleVerifyConfirm} onBack={() => setView('setup')} />;
            }

            return (
                <LearningApp 
                    courses={courses}
                    activeCourseId={activeCourseId}
                    onSwitchCourse={setActiveCourseId}
                    onAddCourse={() => setView('setup')}
                    onUpdateCourse={handleUpdateCourse}
                    onDeleteCourse={handleDeleteCourse}
                    completedMap={completedMap}
                    onToggleComplete={handleToggleComplete}
                    notes={notes}
                    onNoteChange={handleNoteChange}
                    videoProgress={videoProgress.current}
                    onProgressUpdate={handleProgressUpdate}
                    user={user}
                    onLogin={handleLogin}
                    onLogout={handleLogout}
                />
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>